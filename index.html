<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTROL DE CONOCIMIENTOS · MONOMIOS · 2º ESO</title>

  <!-- MathJax (LaTeX) — salida SVG
       FIX PDF: fontCache 'none' para que html2canvas no pierda glifos -->
  <script>
    window.MathJax = {
      options: { enableMenu: false },
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']] },
      svg: { fontCache: 'none' }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <!-- html2canvas + jsPDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --ink:#e5e7eb;
      --muted:#a7b0c0;
      --line:rgba(255,255,255,.10);
      --accent:#60a5fa;
      --ok:#22c55e;
      --bad:#ef4444;
      --kbdW: 320px;
      --kbdGap: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #14264c 0%, var(--bg) 55%) fixed;
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(11,18,32,.95), rgba(11,18,32,.70));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 60px}
    header .wrap{padding:14px 14px}

    /* Título atractivo en mayúsculas */
    h1{
      margin:0;
      font-size:1.15rem;
      letter-spacing:.12em;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .titleTag{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(96,165,250,.12);
      color:#dbeafe;
      font-weight:900;
      letter-spacing:.10em;
      font-size:.82rem;
      text-transform: uppercase;
    }

    /* Reserva espacio a la derecha para el teclado (escritorio) */
    main.wrap{
      padding-right: calc(var(--kbdW) + var(--kbdGap));
    }
    @media(max-width: 980px){
      main.wrap{ padding-right: 14px; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .pill{
      display:inline-flex;align-items:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(96,165,250,.10);
      color:#cfe7ff;font-weight:800;font-size:.85rem;
    }
    .note{color:var(--muted);margin:8px 0 0;line-height:1.35}

    .namebar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    input[type="text"]{
      background: rgba(0,0,0,.25);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      min-width: 280px;
      font-size:1rem;
      outline:none;
    }
    input[type="text"]:focus{border-color: rgba(96,165,250,.75); box-shadow: 0 0 0 3px rgba(96,165,250,.15);}

    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    button:hover{background: rgba(255,255,255,.09)}
    button.primary{background: rgba(96,165,250,.25); border-color: rgba(96,165,250,.55)}
    button.danger{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.55)}

    /* Panel de nota */
    .gradeBox{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-weight:900;
    }
    .gradeBox .glabel{color:var(--muted); font-weight:800}
    .gradeBox .gval{font-size:1.15rem}
    .gradeBox .gsub{color:var(--muted); font-weight:700; font-size:.9rem}

    .sectionTitle{display:flex;justify-content:space-between;align-items:end;gap:10px;flex-wrap:wrap}
    .sectionTitle small{color:var(--muted)}
    .list{margin-top:10px}

    .ex{
      padding:12px 0;
      border-top:1px dashed var(--line);
    }
    .ex:first-child{border-top:none}
    .expr{font-size:1.05rem; line-height:1.25; margin-bottom:10px}

    /* Pasos en una misma línea + preview + estado */
    .stepLine{
      display:grid;
      grid-template-columns: 220px 1fr 1fr 120px;
      gap:10px;
      align-items:start;
      margin:8px 0;
    }
    @media(max-width:820px){
      .stepLine{grid-template-columns: 1fr;}
      .status{justify-self:start}
    }

    .label{color:var(--muted); font-size:.92rem}
    .ans{
      width:100%;
      background: rgba(0,0,0,.25);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      outline:none;
    }
    .ans:focus{border-color: rgba(96,165,250,.75); box-shadow: 0 0 0 3px rgba(96,165,250,.12);}
    .ans:disabled{ opacity:.55; cursor:not-allowed; }

    .preview{
      min-height: 44px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      overflow:auto;
    }
    .preview svg{ max-height: 24px; }

    .status{
      justify-self:end;
      font-weight:900;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      text-align:center;
      min-width: 110px;
    }
    .status.ok{border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.12); color: var(--ok);}
    .status.bad{border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.12); color: var(--bad);}
    .status.neutral{color: var(--muted);}

    .ans.ok{
      border-color: rgba(34,197,94,.65);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
    }
    .ans.bad{
      border-color: rgba(239,68,68,.65);
      box-shadow: 0 0 0 3px rgba(239,68,68,.10);
    }

    /* Teclado flotante */
    #floatingKbd{
      position: fixed;
      right: 14px;
      top: 120px;
      width: var(--kbdW);
      z-index: 100;
      background: rgba(0,0,0,.35);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    @media(max-width:980px){
      #floatingKbd{ width: 300px; }
    }
    @media(max-width:820px){
      #floatingKbd{
        position: sticky;
        top: 10px;
        width: 100%;
        right: auto;
      }
    }

    #floatingKbd h3{margin:0 0 10px;font-size:1rem}
    .keys{display:flex;gap:8px;flex-wrap:wrap}
    .key{
      padding:9px 10px;border-radius:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.06); font-weight:900; cursor:pointer;
      user-select:none;
    }
    .key.alt{background: rgba(96,165,250,.18); border-color: rgba(96,165,250,.35)}
    .key.wide{padding:9px 14px}
    .help{margin-top:10px;color:var(--muted);font-size:.92rem;line-height:1.35}

    .sheet{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
    }

    /* Footer / firma */
    .signature{
      margin-top:14px;
      padding-top:12px;
      border-top:1px dashed var(--line);
      color:var(--muted);
      font-size:.92rem;
      line-height:1.35;
    }

    /* =======================
       MODO PDF (impresión)
       ======================= */
    body.pdf-mode{
      background:#fff !important;
      color:#111 !important;
    }
    body.pdf-mode #floatingKbd,
    body.pdf-mode header,
    body.pdf-mode .namebar button,
    body.pdf-mode #btnReset,
    body.pdf-mode #btnGenerate,
    body.pdf-mode #btnPDF,
    body.pdf-mode .help,
    body.pdf-mode .note{
      display:none !important;
    }
    body.pdf-mode .card,
    body.pdf-mode .sheet{
      background:#fff !important;
      border:1px solid #ddd !important;
      box-shadow:none !important;
    }
    body.pdf-mode .pill{
      background:#f3f4f6 !important;
      color:#111 !important;
      border-color:#d1d5db !important;
    }
    body.pdf-mode .expr{ color:#111 !important; }
    body.pdf-mode .label{ color:#374151 !important; }
    body.pdf-mode .sectionTitle small{ color:#6b7280 !important; }

    body.pdf-mode input[type="text"],
    body.pdf-mode .ans{
      background:#fff !important;
      color:#111 !important;
      border:1px solid #bbb !important;
      box-shadow:none !important;
    }
    body.pdf-mode .preview{
      background:#fff !important;
      border:1px solid #ddd !important;
    }
    body.pdf-mode .status{
      background:#fff !important;
      border:1px solid #ddd !important;
    }
    body.pdf-mode .status.ok{ color:#0a7a2a !important; border-color:#bfe7c9 !important; }
    body.pdf-mode .status.bad{ color:#b91c1c !important; border-color:#f2b8b8 !important; }

    body.pdf-mode .gradeBox{
      background:#fff !important;
      border:1px solid #ddd !important;
    }
    body.pdf-mode .gradeBox .glabel,
    body.pdf-mode .gradeBox .gsub{ color:#374151 !important; }
    body.pdf-mode .gradeBox .gval{ color:#111 !important; }

    body.pdf-mode .signature{
      color:#374151 !important;
      border-top:1px dashed #ddd !important;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>
      <span class="titleTag">2º ESO</span>
      CONTROL DE CONOCIMIENTOS MONOMIOS
    </h1>
  </div>
</header>

<main class="wrap">

  <div class="card sheet" id="sheet">
    <div class="sectionTitle">
      <div>
        <span class="pill">Datos del alumno</span>
        <div class="note">Escribe tu nombre y apellidos y genera tu ficha. A cada alumno le saldrá una ficha distinta al azar.</div>
      </div>
    </div>

    <div class="namebar">
      <input type="text" id="studentName" placeholder="Nombre y Apellidos (obligatorio)" />
      <button class="primary" id="btnGenerate">Generar mi ficha</button>
    </div>

    <div class="btnbar">
      <button class="danger" id="btnReset">Reiniciar</button>
      <div style="display:flex;flex-direction:column;gap:6px;margin-left:auto;align-items:flex-end">
        <button class="primary" id="btnPDF">Generar PDF (pulsa cuando acabes)</button>
        <div style="color:var(--muted);font-size:.86rem;">Puedes enviar aunque falten apartados.</div>
      </div>
    </div>

    <!-- NOTA DINÁMICA -->
    <div class="gradeBox" id="gradeBox" aria-live="polite">
      <span class="glabel">Nota actual:</span>
      <span class="gval"><span id="gradeVal">0.00</span> / 10</span>
      <span class="gsub" id="gradeSub">0 / 0 apartados correctos</span>
    </div>

    <div class="card" style="margin-top:12px; background: rgba(0,0,0,.15)">
      <div class="sectionTitle">
        <div>
          <span class="pill">1 · Suma de monomios semejantes</span>
          <div class="note">Hazlo por pasos: primero suma los positivos, luego los negativos y por último el resultado final.</div>
        </div>
        <small>3–5 términos</small>
      </div>
      <div class="list" id="sec2"></div>
    </div>

    <div class="card" style="margin-top:12px; background: rgba(0,0,0,.15)">
      <div class="sectionTitle">
        <div>
          <span class="pill">2 · Productos y cocientes de monomios</span>
          <div class="note">En producto: multiplica coeficientes y suma exponentes. En cociente: divide coeficientes y resta exponentes.</div>
        </div>
        <small>2–3 factores / con divisiones</small>
      </div>
      <div class="list" id="sec3"></div>
    </div>

    <!-- FIRMA FINAL -->
    <div class="signature">
      Material didáctico creado por Sergio Jodral, profesor de matemáticas, con apoyo de tecnología de inteligencia artificial.
    </div>
  </div>

  <!-- Teclado flotante -->
  <div id="floatingKbd">
    <h3>Teclado matemático</h3>
    <div class="keys">
      <div class="key alt" data-ins="x">x</div>
      <div class="key alt" data-ins="y">y</div>
      <div class="key" data-ins="^">^</div>
      <div class="key" data-ins="+">+</div>
      <div class="key" data-ins="-">−</div>
      <div class="key" data-ins="/">/</div>
      <div class="key" data-ins="(">(</div>
      <div class="key" data-ins=")">)</div>
      <div class="key" data-ins="1">1</div><div class="key" data-ins="2">2</div><div class="key" data-ins="3">3</div>
      <div class="key" data-ins="4">4</div><div class="key" data-ins="5">5</div><div class="key" data-ins="6">6</div>
      <div class="key" data-ins="7">7</div><div class="key" data-ins="8">8</div><div class="key" data-ins="9">9</div>
      <div class="key" data-ins="0">0</div>
      <div class="key wide" id="keyPow2">^2</div>
      <div class="key wide" id="keyPow3">^3</div>
      <div class="key wide" id="keyDel">⌫</div>
    </div>

    <div class="help">
      • Si está mal solo verás <b>“Revisa”</b>. No se muestran soluciones.<br>
      • En “positivos”/“negativos” puedes poner <b>0</b> si no hay términos.
    </div>
  </div>

</main>

<script>
/* ========= RNG con semilla aleatoria ========= */
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
function rint(rng, a, b){ return Math.floor(rng()*(b-a+1))+a; }
function randomSeed32(){
  const a = new Uint32Array(1);
  crypto.getRandomValues(a);
  return a[0] >>> 0;
}

let rng = null;
let focusedInput = null;

/* ========= NOTA DINÁMICA ========= */
const gradeState = {
  total: 0,
  correctMap: new Map()
};
function gradeReset(total){
  gradeState.total = total;
  gradeState.correctMap.clear();
  updateGradeUI();
}
function gradeMark(key, isCorrect){
  gradeState.correctMap.set(key, !!isCorrect);
  updateGradeUI();
}
function gradeCorrectCount(){
  let c = 0;
  for(const v of gradeState.correctMap.values()) if(v===true) c++;
  return c;
}
function updateGradeUI(){
  const correct = gradeCorrectCount();
  const total = gradeState.total || 0;
  const grade = total ? (correct/total*10) : 0;
  document.getElementById("gradeVal").textContent = grade.toFixed(2);
  document.getElementById("gradeSub").textContent = `${correct} / ${total} apartados correctos`;
}

/* ========= Fracciones (internas) ========= */
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b] } return a||1; }
function normFrac(n,d){ if(d<0){ n=-n; d=-d; } const g=gcd(n,d); return {n:n/g,d:d/g}; }
function mulFrac(A,B){ return normFrac(A.n*B.n, A.d*B.d); }
function divFrac(A,B){ return normFrac(A.n*B.d, A.d*B.n); }

function mono(c, e){ return {c, e:{...e}}; }
function monoIsNegative(M){ return M.c.n<0; }

/* ========= LaTeX de monomios ========= */
function monoToLatex(M, parensIfNegative=false){
  if(M.c.n===0) return "0";
  const abs = normFrac(Math.abs(M.c.n), M.c.d);
  const hasVars = (M.e.x!==0 || M.e.y!==0);

  let coef="";
  if(abs.d===1){
    if(abs.n===1 && hasVars) coef="";
    else coef=String(abs.n);
  }else{
    coef = `\\frac{${abs.n}}{${abs.d}}`;
  }

  let vars="";
  if(M.e.x!==0) vars += (M.e.x===1) ? "x" : `x^{${M.e.x}}`;
  if(M.e.y!==0) vars += (M.e.y===1) ? "y" : `y^{${M.e.y}}`;

  let core = `${coef}${vars}`; if(core==="") core="1";
  if(M.c.n<0) core = `-${core}`;
  if(parensIfNegative && M.c.n<0) return `\\left(${core}\\right)`;
  return core;
}
function sumLatex(terms){
  let out="";
  terms.forEach((t,idx)=>{
    const neg = monoIsNegative(t);
    const absT = mono(normFrac(Math.abs(t.c.n), t.c.d), t.e);
    if(idx===0){
      out += monoToLatex(t);
    }else{
      out += neg ? ` - ${monoToLatex(absT)}` : ` + ${monoToLatex(absT)}`;
    }
  });
  return out;
}

/* ========= Parser alumno ========= */
function normalizeInput(s){
  return (s||"").toString()
    .replaceAll(" ","").replaceAll("·","").replaceAll("*","")
    .replaceAll("−","-").toLowerCase();
}
function parseMonomial(s){
  s = normalizeInput(s);
  if(s==="") return null;
  if(s==="0") return mono(normFrac(0,1), {x:0,y:0});

  let sign=1;
  if(s[0]==="+") s=s.slice(1);
  if(s[0]==="-"){ sign=-1; s=s.slice(1); }

  let coefPart="", i=0;
  while(i<s.length && "0123456789/".includes(s[i])){ coefPart+=s[i]; i++; }

  let n=1,d=1;
  if(coefPart!==""){
    if(coefPart.includes("/")){
      const [a,b]=coefPart.split("/");
      n=parseInt(a,10); d=parseInt(b,10);
      if(!Number.isFinite(n)||!Number.isFinite(d)||d===0) return null;
    }else{
      n=parseInt(coefPart,10);
      if(!Number.isFinite(n)) return null;
    }
  }else{
    n=1; d=1;
  }
  n*=sign;

  let ex={x:0,y:0};
  let rest=s.slice(i);

  function parseVar(rest,v){
    const idx=rest.indexOf(v);
    if(idx===-1) return {rest, exp:0};
    let after=rest.slice(idx+1);
    let exp=1;
    if(after.startsWith("^")){
      after=after.slice(1);
      const m=after.match(/^\d+/);
      if(!m) return null;
      exp=parseInt(m[0],10);
      after=after.slice(m[0].length);
    }
    const newRest=rest.slice(0,idx)+after;
    return {rest:newRest, exp};
  }

  const rx=parseVar(rest,"x"); if(rx===null) return null;
  rest=rx.rest; ex.x=rx.exp;
  const ry=parseVar(rest,"y"); if(ry===null) return null;
  rest=ry.rest; ex.y=ry.exp;

  if(rest!=="") return null;
  return mono(normFrac(n,d), ex);
}

/* ========= Comparador ========= */
function sameMonomial(A,B){
  if(A===null || B===null) return false;
  if(A.c.n === 0 && B.c.n === 0) return true;
  const a=normFrac(A.c.n,A.c.d), b=normFrac(B.c.n,B.c.d);
  return a.n===b.n && a.d===b.d && A.e.x===B.e.x && A.e.y===B.e.y;
}

/* ========= Preview segura ========= */
async function updatePreviewSafe(previewId, inputValue){
  const el = document.getElementById(previewId);
  if(!el) return;

  const raw = (inputValue || "").trim();
  if(raw === ""){
    el.innerHTML = "";
    return;
  }

  const parsed = parseMonomial(raw);
  if(parsed === null){
    el.innerHTML = "";
    return;
  }

  let s = normalizeInput(raw);
  s = s.replace(/x\^(\d+)/g, "x^{\$1}").replace(/y\^(\d+)/g, "y^{\$1}");
  el.innerHTML = `\\(${s}\\)`;

  if(window.MathJax?.typesetPromise){
    try{ await MathJax.typesetPromise([el]); }catch(_e){ el.innerHTML=""; }
  }
}

/* ========= Generación de ejercicios ========= */
function pickLiteralPattern(rng){
  const patterns=[
    {x:rint(rng,1,5), y:0},
    {x:0, y:rint(rng,1,5)},
    {x:rint(rng,1,4), y:rint(rng,1,4)}
  ];
  return patterns[rint(rng,0,patterns.length-1)];
}
function randomNonZeroInt(rng, a, b){
  let v=0; while(v===0) v=rint(rng,a,b);
  return v;
}

/* Sección 1 */
function makeLikeTermsExercise(rng, idx){
  const e = pickLiteralPattern(rng);
  const nTerms = rint(rng,3,5);

  const terms=[];
  let posSum = mono(normFrac(0,1), e);
  let negSum = mono(normFrac(0,1), e);
  let total  = mono(normFrac(0,1), e);

  for(let i=0;i<nTerms;i++){
    const cInt = randomNonZeroInt(rng, -12, 12);
    const t = mono(normFrac(cInt,1), e);
    terms.push(t);

    if(cInt>0) posSum = mono(normFrac(posSum.c.n + cInt, 1), e);
    if(cInt<0) negSum = mono(normFrac(negSum.c.n + cInt, 1), e);
    total = mono(normFrac(total.c.n + cInt, 1), e);
  }

  if(total.c.n===0){
    const extra = randomNonZeroInt(rng,-10,10);
    const t = mono(normFrac(extra,1), e);
    terms.push(t);
    if(extra>0) posSum = mono(normFrac(posSum.c.n + extra, 1), e);
    if(extra<0) negSum = mono(normFrac(negSum.c.n + extra, 1), e);
    total = mono(normFrac(total.c.n + extra, 1), e);
  }

  return {
    id:`s1_${idx}`,
    label:String.fromCharCode(97+idx)+")",
    exprLatex: `\\(${sumLatex(terms)}\\)`,
    posAnswer: posSum,
    negAnswer: negSum,
    finalAnswer: total
  };
}

/* Sección 2 */
function monoMul(A,B){ return mono(mulFrac(A.c,B.c), {x:A.e.x+B.e.x, y:A.e.y+B.e.y}); }
function monoDiv(A,B){ return mono(divFrac(A.c,B.c), {x:A.e.x-B.e.x, y:A.e.y-B.e.y}); }

function makeProdOrQuotExercise(rng, idx){
  function randMono(){
    const e = pickLiteralPattern(rng);
    const useFrac = (rng() < 0.15);
    let c;
    if(useFrac){
      const num = randomNonZeroInt(rng,-9,9);
      const den = rint(rng,2,6);
      c = normFrac(num, den);
    }else{
      c = normFrac(randomNonZeroInt(rng,-9,9), 1);
    }
    return mono(c,e);
  }

  const type = (rng() < 0.55) ? "prod" : "quot";
  if(type==="prod"){
    const k = rint(rng,2,3);
    let res = mono(normFrac(1,1), {x:0,y:0});
    const factors=[];
    for(let i=0;i<k;i++){
      const m=randMono();
      factors.push(m);
      res=monoMul(res,m);
    }
    const latexFactors = factors.map(m=>monoToLatex(m,true));
    return { id:`s2_${idx}`, label:String.fromCharCode(97+idx)+")", exprLatex:`\\(${latexFactors.join(" \\cdot ")}\\)`, answer: res };
  }else{
    let A=randMono();
    let B=randMono();
    A.e.x = Math.max(A.e.x, B.e.x + rint(rng,0,3));
    A.e.y = Math.max(A.e.y, B.e.y + rint(rng,0,3));

    const kNum = randomNonZeroInt(rng,-9,9);
    const kDen = (rng()<0.18) ? rint(rng,2,6) : 1;
    const K = normFrac(kNum,kDen);
    A.c = mulFrac(B.c, K);

    const res = monoDiv(A,B);
    return { id:`s2_${idx}`, label:String.fromCharCode(97+idx)+")", exprLatex:`\\( ${monoToLatex(A,true)} \\; : \\; ${monoToLatex(B,true)} \\)`, answer: res };
  }
}

/* ========= Render + comprobador ========= */
let EX1=[], EX2=[];

function setStatus(inputEl, statusEl, state){
  statusEl.className = "status " + state;
  inputEl.classList.remove("ok","bad");
  if(state==="neutral"){ statusEl.textContent="—"; return; }
  if(state==="ok"){ statusEl.textContent="OK"; inputEl.classList.add("ok"); return; }
  if(state==="bad"){ statusEl.textContent="Revisa"; inputEl.classList.add("bad"); return; }
}

function renderAll(){
  const sec1=document.getElementById("sec2");
  const sec2=document.getElementById("sec3");

  sec1.innerHTML = EX1.map(ex=>`
    <div class="ex">
      <div class="expr"><b>${ex.label}</b> ${ex.exprLatex} =</div>

      <div class="stepLine">
        <div class="label">Paso 1 (positivos):</div>
        <input class="ans" id="${ex.id}_pos" placeholder="Ej: 11x^2 (o 0)" />
        <div class="preview" id="${ex.id}_pos_p"></div>
        <div class="status neutral" id="${ex.id}_pos_s">—</div>
      </div>

      <div class="stepLine">
        <div class="label">Paso 2 (negativos):</div>
        <input class="ans" id="${ex.id}_neg" placeholder="Ej: -7x^2 (o 0)" disabled />
        <div class="preview" id="${ex.id}_neg_p"></div>
        <div class="status neutral" id="${ex.id}_neg_s">—</div>
      </div>

      <div class="stepLine">
        <div class="label"><b>Paso 3 (final):</b></div>
        <input class="ans" id="${ex.id}_fin" placeholder="Ej: 4x^2" disabled />
        <div class="preview" id="${ex.id}_fin_p"></div>
        <div class="status neutral" id="${ex.id}_fin_s">—</div>
      </div>
    </div>
  `).join("");

  sec2.innerHTML = EX2.map(ex=>`
    <div class="ex">
      <div class="stepLine" style="grid-template-columns: 1fr 1fr 1fr 120px">
        <div class="expr"><b>${ex.label}</b> ${ex.exprLatex} =</div>
        <input class="ans" id="${ex.id}" placeholder="Tu respuesta (monomio)" />
        <div class="preview" id="${ex.id}_p"></div>
        <div class="status neutral" id="${ex.id}_s">—</div>
      </div>
    </div>
  `).join("");

  document.querySelectorAll("input.ans").forEach(inp=>{
    inp.addEventListener("focus", ()=>{ focusedInput=inp; positionKeyboardNearInput(); });
    inp.addEventListener("click", ()=>{ focusedInput=inp; positionKeyboardNearInput(); });
  });

  attachRealtimeCheckers();

  if(window.MathJax?.typesetPromise) MathJax.typesetPromise();
}

function attachRealtimeCheckers(){
  EX1.forEach(ex=>{
    const posI = document.getElementById(ex.id+"_pos");
    const negI = document.getElementById(ex.id+"_neg");
    const finI = document.getElementById(ex.id+"_fin");

    const posS = document.getElementById(ex.id+"_pos_s");
    const negS = document.getElementById(ex.id+"_neg_s");
    const finS = document.getElementById(ex.id+"_fin_s");

    const gradeKey = ex.id + "_FINAL";

    function checkPos(){
      updatePreviewSafe(ex.id+"_pos_p", posI.value);
      const u = parseMonomial(posI.value);
      const good = sameMonomial(u, ex.posAnswer);
      if(posI.value.trim()===""){
        setStatus(posI,posS,"neutral");
        negI.disabled=true; finI.disabled=true;
        gradeMark(gradeKey, false);
        return;
      }
      setStatus(posI,posS, good ? "ok" : "bad");
      negI.disabled = !good;
      if(!good){
        finI.disabled=true;
        gradeMark(gradeKey, false);
      }
    }
    function checkNeg(){
      updatePreviewSafe(ex.id+"_neg_p", negI.value);
      const u = parseMonomial(negI.value);
      const good = sameMonomial(u, ex.negAnswer);
      if(negI.value.trim()===""){
        setStatus(negI,negS,"neutral");
        finI.disabled=true;
        gradeMark(gradeKey, false);
        return;
      }
      setStatus(negI,negS, good ? "ok" : "bad");
      finI.disabled = !good;
      if(!good) gradeMark(gradeKey, false);
    }
    function checkFin(){
      updatePreviewSafe(ex.id+"_fin_p", finI.value);
      const u = parseMonomial(finI.value);
      const good = sameMonomial(u, ex.finalAnswer);
      if(finI.value.trim()===""){
        setStatus(finI,finS,"neutral");
        gradeMark(gradeKey, false);
        return;
      }
      setStatus(finI,finS, good ? "ok" : "bad");
      gradeMark(gradeKey, !!good);
    }

    posI.addEventListener("input", checkPos);
    negI.addEventListener("input", checkNeg);
    finI.addEventListener("input", checkFin);

    setStatus(posI,posS,"neutral");
    setStatus(negI,negS,"neutral");
    setStatus(finI,finS,"neutral");

    gradeMark(gradeKey, false);
  });

  EX2.forEach(ex=>{
    const inp = document.getElementById(ex.id);
    const st  = document.getElementById(ex.id+"_s");
    const gradeKey = ex.id + "_ONE";

    function check(){
      updatePreviewSafe(ex.id+"_p", inp.value);
      const u = parseMonomial(inp.value);
      const good = sameMonomial(u, ex.answer);
      if(inp.value.trim()===""){
        setStatus(inp,st,"neutral");
        gradeMark(gradeKey, false);
        return;
      }
      setStatus(inp,st, good ? "ok" : "bad");
      gradeMark(gradeKey, !!good);
    }
    inp.addEventListener("input", check);
    setStatus(inp,st,"neutral");
    gradeMark(gradeKey, false);
  });
}

function resetAll(){
  document.querySelectorAll("input.ans").forEach(i=> i.value="");
  document.querySelectorAll("input.ans").forEach(i=> i.classList.remove("ok","bad"));
  document.querySelectorAll(".status").forEach(s=>{ s.className="status neutral"; s.textContent="—"; });
  document.querySelectorAll(".preview").forEach(p=> p.innerHTML="");
  EX1.forEach(ex=>{
    document.getElementById(ex.id+"_neg").disabled = true;
    document.getElementById(ex.id+"_fin").disabled = true;
  });

  for(const k of gradeState.correctMap.keys()) gradeState.correctMap.set(k,false);
  updateGradeUI();
}

/* ========= Teclado ========= */
function insertAtCursor(input, text){
  const start=input.selectionStart ?? input.value.length;
  const end=input.selectionEnd ?? input.value.length;
  input.value = input.value.slice(0,start) + text + input.value.slice(end);
  const pos=start+text.length;
  input.setSelectionRange(pos,pos);
  input.focus();
  input.dispatchEvent(new Event("input",{bubbles:true}));
}
function backspace(input){
  const start=input.selectionStart ?? input.value.length;
  const end=input.selectionEnd ?? input.value.length;
  if(start!==end){
    input.value=input.value.slice(0,start)+input.value.slice(end);
    input.setSelectionRange(start,start);
  }else if(start>0){
    input.value=input.value.slice(0,start-1)+input.value.slice(start);
    input.setSelectionRange(start-1,start-1);
  }
  input.focus();
  input.dispatchEvent(new Event("input",{bubbles:true}));
}
document.querySelectorAll(".key[data-ins]").forEach(k=>{
  k.addEventListener("click", ()=>{
    if(!focusedInput){ alert("Haz clic primero en una casilla de respuesta."); return; }
    insertAtCursor(focusedInput, k.dataset.ins);
  });
});
document.getElementById("keyDel").addEventListener("click", ()=>{
  if(!focusedInput){ alert("Haz clic primero en una casilla de respuesta."); return; }
  backspace(focusedInput);
});
document.getElementById("keyPow2").addEventListener("click", ()=>{
  if(!focusedInput){ alert("Haz clic primero en una casilla de respuesta."); return; }
  insertAtCursor(focusedInput, "^2");
});
document.getElementById("keyPow3").addEventListener("click", ()=>{
  if(!focusedInput){ alert("Haz clic primero en una casilla de respuesta."); return; }
  insertAtCursor(focusedInput, "^3");
});

/* ========= Teclado “a la altura” ========= */
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
function positionKeyboardNearInput(){
  const kbd = document.getElementById("floatingKbd");
  if(!focusedInput || window.matchMedia("(max-width: 820px)").matches) return;

  const r = focusedInput.getBoundingClientRect();
  const kbdH = kbd.offsetHeight;
  const margin = 12;
  const targetTop = r.top - 20;
  const minTop = 90;
  const maxTop = window.innerHeight - kbdH - margin;
  kbd.style.top = clamp(targetTop, minTop, maxTop) + "px";
}
window.addEventListener("scroll", ()=> positionKeyboardNearInput(), {passive:true});
window.addEventListener("resize", ()=> positionKeyboardNearInput());

/* ========= PDF ========= */
async function forceTypesetOn(node){
  if(!window.MathJax?.typesetPromise) return;
  try{
    if(window.MathJax.typesetClear) MathJax.typesetClear([node]);
    await MathJax.typesetPromise([node]);
  }catch(e){}
}
async function settleFrames(n=3){
  for(let i=0;i<n;i++){
    await new Promise(r => requestAnimationFrame(() => r()));
  }
}
async function generatePDF(){
  const name = document.getElementById("studentName").value.trim();
  if(!name){
    alert("Pon Nombre y Apellidos antes de generar el PDF.");
    return;
  }

  document.body.classList.add("pdf-mode");

  await settleFrames(4);

  const node = document.getElementById("sheet");
  await forceTypesetOn(node);
  await new Promise(r => setTimeout(r, 120));

  const canvas = await html2canvas(node, {
    scale: 3,
    backgroundColor: "#ffffff",
    useCORS: true,
    logging: false
  });

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:"p", unit:"mm", format:"a4"});

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const margin = 10;

  const contentW = pageW - 2*margin;
  const contentH = pageH - 2*margin;

  const pxPerMm = canvas.width / contentW;
  const pagePxH = Math.floor(contentH * pxPerMm);

  let y = 0;
  let pageIndex = 0;

  while(y < canvas.height){
    const sliceH = Math.min(pagePxH, canvas.height - y);

    const pageCanvas = document.createElement("canvas");
    pageCanvas.width = canvas.width;
    pageCanvas.height = sliceH;

    const ctx = pageCanvas.getContext("2d");
    ctx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);

    const imgData = pageCanvas.toDataURL("image/jpeg", 0.92);
    const imgHmm = sliceH / pxPerMm;

    if(pageIndex > 0) pdf.addPage();

    pdf.setFont("helvetica","bold");
    pdf.setFontSize(11);
    pdf.text(`Alumno: ${name}`, margin, 8);

    pdf.addImage(imgData, "JPEG", margin, margin, contentW, imgHmm);

    y += sliceH;
    pageIndex++;
  }

  document.body.classList.remove("pdf-mode");

  const safeName = name.replace(/[^\p{L}\p{N}\s_-]/gu,"").trim().replace(/\s+/g,"_");
  pdf.save(`Monomios_2ESO_${safeName}.pdf`);
}

/* ========= Generar ficha (azar) ========= */
function generateSheet(){
  const name=document.getElementById("studentName").value.trim();
  if(!name){
    alert("Escribe Nombre y Apellidos para generar tu ficha.");
    return;
  }

  rng = mulberry32(randomSeed32());

  EX1=[]; EX2=[];
  const n1=7, n2=7;
  for(let i=0;i<n1;i++) EX1.push(makeLikeTermsExercise(rng,i));
  for(let i=0;i<n2;i++) EX2.push(makeProdOrQuotExercise(rng,i));

  gradeReset(n1 + n2);

  renderAll();
  resetAll();
}

/* ========= Botones ========= */
document.getElementById("btnGenerate").addEventListener("click", generateSheet);
document.getElementById("btnReset").addEventListener("click", resetAll);
document.getElementById("btnPDF").addEventListener("click", generatePDF);

document.getElementById("studentName").addEventListener("keydown",(e)=>{
  if(e.key==="Enter") generateSheet();
});
</script>

</body>
</html>
